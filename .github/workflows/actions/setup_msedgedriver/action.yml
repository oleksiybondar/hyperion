name: "Set up msedgedriver"
description: "Install msedgedriver matching installed Microsoft Edge"
runs:
  using: "composite"
  steps:
    - name: Install msedgedriver (match installed Edge)
      shell: bash
      run: |
        set -euo pipefail

        echo "Edge version:"
        EDGE_VER="$( (msedge --version 2>/dev/null || true) ; (microsoft-edge --version 2>/dev/null || true) | head -n1 )"
        echo "$EDGE_VER"

        EDGE_MAJOR="$(echo "$EDGE_VER" | grep -oE '[0-9]+' | head -n1)"
        if [ -z "${EDGE_MAJOR:-}" ]; then
          echo "Could not detect Edge major version" >&2
          exit 1
        fi
        echo "EDGE_MAJOR=$EDGE_MAJOR"

        DRIVER_VER="$(curl -fsSL --retry 5 --retry-delay 2 --retry-all-errors \
          "https://msedgedriver.azureedge.net/LATEST_RELEASE_${EDGE_MAJOR}_LINUX")"
        echo "Driver version: $DRIVER_VER"

        curl -fsSL --retry 5 --retry-delay 2 --retry-all-errors \
          -o /tmp/edgedriver.zip \
          "https://msedgedriver.azureedge.net/${DRIVER_VER}/edgedriver_linux64.zip"

        unzip -q /tmp/edgedriver.zip -d /tmp/edgedriver
        chmod +x /tmp/edgedriver/msedgedriver
        sudo mv /tmp/edgedriver/msedgedriver /usr/local/bin/msedgedriver

        echo "Installed driver:"
        /usr/local/bin/msedgedriver --version